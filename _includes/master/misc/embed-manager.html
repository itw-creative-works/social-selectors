<script type="text/javascript">
  // https://stackoverflow.com/questions/326069/how-to-identify-if-a-webpage-is-being-loaded-inside-an-iframe-or-directly-into-t
  var inIframe = false;
  try {
    inIframe = window.self !== window.top;
  } catch (e) {
    inIframe = true;
  }

  if (inIframe) {
    function _sendParentMessage(message) {
      window.parent.postMessage(message, '*')
    }

    // Fetch build.json
    fetch('{{ site.url }}/@output/build/build.json?cb=' + new Date().getTime(), {
      method: 'GET',
    })
    .then(function (res) {
      if (res.ok) {
        res.json()
        .then(function (data) {
          _sendParentMessage({
            command: 'embed-manager:update',
            payload: {
              type: 'init',
              url: window.location.href,
              build: data,
            },
          })
        })
      } else {
        return res.text()
        .then(function (data) {
          throw new Error(data || res.statusText || 'Unknown error.')
        })
      }
    })
    .catch(function (e) {
      alert('Failed to fetch build.json: ' + e)
    })

    // Fetch auth
    Manager.auth().ready(function () {
      var user = firebase.auth().currentUser || {};
      _sendParentMessage({
        command: 'embed-manager:update',
        payload: {
          type: 'auth',
          user: {
            authenticated: !!user.uid,
            uid: user.uid,
            email: user.email,
          },

        }
      })
    })

  }
</script>
